$package("loon.core");var config={queue:[],updateRate:1E3,autorun:!0,blocking:!1,useCanvasUpdate:!0,beforeLoadMainFunction:!0,beforeMainImport:!0};function OnMain(){}function OnProcess(){}function OnUpdate(){}function Setting(){}var _game_core=null;function register(h){_game_core=new loon.Core(h.width,h.height);_game_core.setFPS(h.fps);_game_core.setShowFPS(h.showFps);h.preload!=null&&h.preload.length>0&&_game_core.preload(h.preload)}var context=function(){return _game_core};
function $package(h){for(var n=window,p=h.split("."),h=0;h<p.length;h++)typeof n[p[h]]==="undefined"&&(n[p[h]]={}),n=n[p[h]]}function Point(){}function RectBox(){}
(function(h,n){function p(a){config.queue.push(a);config.autorun&&!config.blocking&&x()}function x(){for(var a=h.getTime();config.queue.length&&!config.blocking;)if(config.updateRate<=0||h.getTime()-a<config.updateRate)config.queue.shift()();else{setTimeout(x,13);break}}function v(){}function y(a,b){this.running=!1;this.name="Thread";if(a instanceof v)this.runnable=a,this.name=b||"Thread";else if(typeof a==="string")this.name=a;this.context=null;this.priority=0}function D(a,b){this.key=a;this.value=
b;this.valueOf=function(){return this.value};this.toString=function(){return String(this.value)}}function z(a){var b=0;this.element=a[b]||null;this.atEnd=function(){return b>=a.length};this.get=function(){return this.atEnd()?null:this.element=a[b++]};this.map=function(b,e){return dojo.map(a,b,e)};this.reset=function(){b=0;this.element=a[b]}}function E(a){var b=[],d={},e;for(e in a)d[e]||b.push(a[e]);var c=0;this.element=b[c]||null;this.atEnd=function(){return c>=b.length};this.get=function(){return this.atEnd()?
null:this.element=b[c++]};this.map=function(a,d){return dojo.map(b,a,d)};this.reset=function(){c=0;this.element=b[c]}}function F(){var a=null,b=null,d=document.getElementsByTagName("head").item(0);for(i=0;i<arguments.length;i++)if(a=arguments[i],!A.contains(a)&&(b=document.createElement("script"),b!=n))navigator.userAgent.indexOf("Trident/5")>-1?(b.src=a,b.serial=i+1):(b.async=!1,b.src=a),d!=n?d.appendChild(b):document.body.appendChild(b),A.add(a)}function G(){p(function(){c();if(config.beforeMainImport)F("main.js"),
h.onload=function(){OnMain();if(_game_core!=null)_game_core.onload=function(){OnProcess(_game_core);config.useCanvasUpdate&&_game_core.root._context==null&&_game_core.root.addLayer("Canvas",0)},_game_core.show()}})}h.getTime=function(){return h.performance&&h.performance.now?function(){return h.performance.now()}:h.performance&&h.performance.webkitNow?function(){return h.performance.webkitNow()}:Date.now}();v.prototype={constructor:v,run:function(){}};y.prototype={constructor:y,getName:function(){return this.name},
getPriority:function(){return this.priority},setName:function(a){this.name=a||this.name},setPriority:function(a){this.priority=a},start:function(){this.running=!0},_isRunning:function(){return this.running},run:function(){running&&runnable!=null&&this.runnable.run()},stop:function(){this.running=!1},toString:function(){return this.name}};if(typeof Object.defineProperty!=="function")Object.defineProperty=function(a,b,d){if("value"in d)a[b]=d.value;"get"in d&&a.__defineGetter__(b,d.get);"set"in d&&
a.__defineSetter__(b,d.set);return a};if(typeof Object.defineProperties!=="function")Object.defineProperties=function(a,b){for(var d in b)b.hasOwnProperty(d)&&Object.defineProperty(a,d,b[d]);return a};if(typeof Object.extend!=="function")Object.extend=function(a,b){function d(){}d.prototype=a;var e=new d;b!=null&&Object.defineProperties(e,b);return e};if(typeof Object.getPrototypeOf!=="function")Object.getPrototypeOf=function(a){return a.__proto__};if(typeof Function.prototype.bind!=="function")Function.prototype.bind=
function(a){var b=this,d=Array.prototype.slice.call(arguments,1),e=function(){},c=function(){var c=d.concat(Array.prototype.slice.call(arguments));return b.apply(this instanceof e?this:a||h,c)};e.prototype=b.prototype;c.prototype=new e;return c};h.requestFrame=h.requestFrame||h.mozrequestFrame||h.webkitrequestFrame||h.msrequestFrame||function(){var a=h.getTime(),b=1E3/60;return function(d){var e=h.getTime(),c=setTimeout(function(){d(h.getTime())},Math.max(0,a+b-e));a=e;return c}}();var c=function(a){a!=
null&&(a instanceof Array||(a=Array.prototype.slice.call(arguments)),a=a.filter(function(a){return""+a}));(function d(e,c){var g=[],k,j;for(j in e)e.hasOwnProperty(j)&&(typeof e[j]==="function"?h[j]=e[j]:typeof e[j]==="object"&&e[j]!==null&&Object.getPrototypeOf(e[j])===Object.prototype&&(a==null?g.push(j):(k=a.indexOf(c+j),k!==-1&&(g.push(j),a.splice(k,1)))));k=0;for(j=g.length;k<j;k++)d(e[g[k]],c+g[k]+".")})(c,"");if(a!=null&&a.length)throw Error("Cannot load module: "+a.join(", "));};h.loon=c;
h.addEventListener("message",function(a){try{var b=JSON.parse(a.data);if(b.type==="event")c.Core.instance.dispatchEvent(new c.Event(b.value));else if(b.type==="debug")switch(b.value){case "start":c.Core.instance.start();break;case "pause":c.Core.instance.pause();break;case "resume":c.Core.instance.resume();break;case "tick":c.Core.instance._tick()}}catch(d){}},!1);c.Class=function(a,b){return c.Class.extend(a,b)};c.Class.typeOf=function(a){var b=typeof a;if(b=="object")if(a){if(a instanceof Array)return"array";
else if(a instanceof Object)return b;var d=Object.prototype.toString.call(a);if(d=="[object Window]")return"object";if(d=="[object Array]"||typeof a.length=="number"&&typeof a.splice!="undefined"&&typeof a.propertyIsEnumerable!="undefined"&&!a.propertyIsEnumerable("splice"))return"array";if(d=="[object Function]"||typeof a.call!="undefined"&&typeof a.propertyIsEnumerable!="undefined"&&!a.propertyIsEnumerable("call"))return"function"}else return"null";else if(b=="function"&&typeof a.call=="undefined")return"object";
return b};c.isDef=function(a){return a!==n};c.isNull=function(a){return a===null};c.isArray=function(a){return c.Class.typeOf(a)=="array"};c.isString=function(a){return typeof a=="string"};c.isBoolean=function(a){return typeof a=="boolean"};c.isNumber=function(a){return typeof a=="number"};c.isFunction=function(a){return c.Class.typeOf(a)=="function"};c.isObject=function(a){var b=typeof a;return b=="object"&&a!=null||b=="function"};c.Class.extend=function(a,b){if(a==null&&b)throw Error("superclass is undefined (loon.Class.extend)");
else if(a==null)throw Error("definition is undefined (loon.Class.extend)");if(arguments.length===0)return c.Class.extend(Object,b);else if(arguments.length===1&&typeof arguments[0]!=="function")return c.Class.extend(Object,arguments[0]);for(var d in b)if(b.hasOwnProperty(d))if(typeof b[d]==="object"&&b[d]!==null&&Object.getPrototypeOf(b[d])===Object.prototype){if(!("enumerable"in b[d]))b[d].enumerable=!0}else b[d]={value:b[d],enumerable:!0,writable:!0};var e=function(){if(this instanceof e)e.prototype.initialize.apply(this,
arguments);else return new e};e.prototype=Object.extend(a.prototype,b);e.prototype.constructor=e;if(e.prototype.initialize==null)e.prototype.initialize=function(){a.apply(this,arguments)};d=this.getSupers(a);for(var f=d.length-1;f>=0;f--)if(typeof d[f]._inherited==="function"){d[f]._inherited(e);break}return e};c.Class.getSupers=function(a){for(var b=[],d=a.prototype;a!==Object;)b.push(a),d=Object.getPrototypeOf(d),a=d.constructor;return b};c.Class.clone=function(a){var b=c.typeOf(a);if(b=="object"||
b=="array"){if(a.clone)return a.clone();var b=b=="array"?[]:{},d;for(d in a)b[d]=c.clone(a[d]);return b}return a};c.basePath=null;c.main=function(){if(c.basePath===null)for(var a=document.getElementsByTagName("script"),b=0;b<a.length;b++){var d=a[b].src.match(/(^|.*[\\\/])main.js(?:\?.*)?$/i);if(d){c.basePath=d[1];break}}return c.basePath};c.newInstance=function(a){var b,d;b=a.split(".");d=b[b.length-1];for(var a=h,e=0;e<b.length-1;e++)a=a[b[e]];return new a[d]};c.List=function(a){var b=[];a&&(b=
b.concat(a));this.count=b.length;this.add=function(a){b.push(a);this.count=b.length};this.addRange=function(a){if(a.getIterator)for(a=a.getIterator();!a.atEnd();)this.add(a.get());else for(var e=0;e<a.length;e++)b.push(a[e]);this.count=b.length};this.clear=function(){b.splice(0,b.length);this.count=0};this.clone=function(){return new c.ArrayList(b)};this.contains=function(a){for(var e=0;e<b.length;e++)if(b[e]==a)return!0;return!1};this.getIterator=function(){return new z(b)};this.indexOf=function(a){for(var e=
0;e<b.length;e++)if(b[e]==a)return e;return-1};this.insert=function(a,e){b.splice(a,0,e);this.count=b.length};this.item=function(a){return b[a]};this.remove=function(a){a=this.indexOf(a);a>=0&&b.splice(a,1);this.count=b.length};this.removeAt=function(a){b.splice(a,1);this.count=b.length};this.reverse=function(){b.reverse()};this.sort=function(a){a?b.sort(a):b.sort()};this.setByIndex=function(a,e){b[a]=e;this.count=b.length};this.toArray=function(){return[].concat(b)};this.toString=function(a){return b.join(a||
",")}};c.Dictionary=function(a){var b={};this.count=0;var d={};this.add=function(a,d){var c=a in b;b[a]=new D(a,d);c||this.count++};this.clear=function(){b={};this.count=0};this.clone=function(){return new c.Dictionary(this)};this.contains=this.containsKey=function(a){return d[a]?!1:b[a]!=null};this.containsValue=function(a){for(var b=this.getIterator();b.get();)if(b.element.value==a)return!0;return!1};this.entry=function(a){return b[a]};this.getKeys=function(){return this.getIterator().map(function(a){return a.key})};
this.getValues=function(){return this.getIterator().map(function(a){return a.value})};this.item=function(a){return a in b?b[a].valueOf():n};this.getIterator=function(){return new E(b)};this.remove=function(a){return a in b&&!d[a]?(delete b[a],this.count--,!0):!1};if(a)for(a=a.getIterator();a.get();)this.add(a.element.key,a.element.value)};c.Stack=function(a){var b=[];a&&(b=b.concat(a));this.count=b.length;this.clear=function(){b=[];this.count=b.length};this.clone=function(){return new c.Stack(b)};
this.contains=function(a){for(var c=0;c<b.length;c++)if(b[c]==a)return!0;return!1};this.copyTo=function(a,c){a.splice(c,0,b)};this.getIterator=function(){return new z(b)};this.peek=function(){return b[b.length-1]};this.pop=function(){var a=b.pop();this.count=b.length;return a};this.push=function(a){this.count=b.push(a)};this.toArray=function(){return[].concat(b)}};var A=new c.List;c.DEG_TO_RAD=Math.PI/180;c.RAD_TO_DEG=180/Math.PI;c.rToD=function(a){return a*c.DEG_TO_RAD};c.dToR=function(a){return a*
c.RAD_TO_DEG};c.random=function(a){return Math.random()*a};c.random=function(a,b){return a+Math.random()*(b-a)};c.find=function(a){return document.getElementById&&document.getElementById(a)?document.getElementById(a):document.all&&document.all(a)?document.all(a):document.layers&&document.layers[a]?document.layers[a]:null};c.request=function(a){if(h.XMLHttpRequest){var b=new XMLHttpRequest;a!==null&&b.overrideMimeType&&b.overrideMimeType(a);return b}else return new ActiveXObject("Msxml2.XMLHTTP")};
c.classExists=function(a){var b=a.split("."),d="",c;for(c=0;c<b.length;c++)if(d+=(c>0?".":"")+b[c],eval("typeof "+d)==="undefined")return!1;return eval("typeof "+a)==="function"};c.js=function(a,b,d){var e=c.request("text/plain");e.onreadystatechange=function(){if(e.readyState===4)if(e.status===200||e.status===0){var c=document.createElement("script");c.language="javascript";e.responseText!=null&&e.responseText.length>0?c.text=e.responseText:c.src=a;c.type="text/javascript";var g=document.getElementsByTagName("head")[0];
if(g===null){var g=document.createElement("head"),k=document.getElementsByTagName("html")[0];k.insertBefore(g,k.firstChild)}try{g.appendChild(c)}catch(j){alert("There was an error loading the script from '"+a+"': "+j);return}b&&b(a)}else if(e.status===404&&(alert("404 error: the requested resource '"+a+"' could not be found."),d&&d(),c.src!=null))return list};e.open("GET",a,!1);e.send(null)};c.make=function(a,b){var d=document.createElement(a),c;for(c in b){var f=b[c];if(c=="style")for(var g in f)d.style[g]=
f[g];else d[c]=f}return d};c.store={isSupported:function(){try{return"localStorage"in h&&h.localStorage!==null}catch(a){return!1}},getItem:function(a){return isSupported()?getItem(a):n},setItem:function(a,b){isSupported()&&(localStorage[a]=b)},remove:function(a){isSupported()&&localStorage.removeItem(a)},clear:function(){isSupported()&&clear()},length:function(){if(isSupported())return localStorage.length},getKey:function(a){if(isSupported())return localStorage.key(a)}};c.System={_use_touch:!1,VERSION:"0.3.3-min",
ON_MOBILE:navigator.userAgent.indexOf("mobile")!=-1||navigator.userAgent.indexOf("android")!=-1,UA:navigator.userAgent.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],BROWSER:function(){var a=navigator.userAgent;return a.indexOf("Opera")!==-1?"O":a.indexOf("MSIE")!==-1?"ms":a.indexOf("WebKit")!==-1?"webkit":navigator.product==="Gecko"?"Moz":""}(),SUPPORT_TOUCH:function(){if(this._use_touch)return _use_touch;var a=document.createElement("div");
a.setAttribute("ontouchstart","return");return this._use_touch=typeof a.ontouchstart==="function"}(),RETINA_IOS_DISPLAY:function(){if(navigator.userAgent.indexOf("iPhone")!==-1&&h.devicePixelRatio===2){var a=document.querySelector('meta[name="viewport"]');a==null&&(a=document.createElement("meta"),document.head.appendChild(a));a.setAttribute("content","width=640");return!0}else return!1}(),SUPPORT_FLASH_SOUND:function(){var a=navigator.userAgent,b=navigator.vendor||"";return location.href.indexOf("http")===
0&&a.indexOf("Mobile")===-1&&b.indexOf("Apple")!==-1}(),USE_DEFAULT_EVENT_TAGS:["input","textarea","select","area"],CANVAS_DRAWING_METHODS:["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"],KEY_BIND_TABLE:{37:"left",38:"up",39:"right",40:"down"},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40,32],SOUND_ENABLED_ON_MOBILE_SAFARI:!1,USE_WEBAUDIO:location.protocol!=="file:",USE_ANIMATION:!0};c.Event=c.Class.extend({initialize:function(a){this.type=
a;this.target=null;this.localY=this.localX=this.y=this.x=0},_initPosition:function(a,b){var d=c.Core.instance;this.x=this.localX=(a-d._pageX)/d.scale;this.y=this.localY=(b-d._pageY)/d.scale}});c.Color=c.Class.extend({r:0,g:0,b:0,a:0,initialize:function(a,b,d,c){this.set(a,b,d,c)},set:function(a,b,d,c){if(a)this.r=a;if(b)this.g=b;if(d)this.b=d;if(c)this.a=c},getColorAsRGBAString:function(a,b,d,c){a=Math.round(a);b=Math.round(b);d=Math.round(d);return b==n?"rgba("+a+","+b+","+d+","+c+")":c==n?"rgba("+
a+","+b+","+d+",255)":"rgba("+a+","+b+","+d+","+c+")"},toRGBAString:function(){return c.Color.getColorAsRGBAString(this.r,this.g,this.b,this.a)}});c.TEXT_ALIGN_LEFT=0;c.TEXT_BASELINE_TOP=1;c.TEXT_BASELINE_BOTTOM=2;c.Font=c.Class.extend({text:"",font:"Arial",size:20,alignment:c.TEXT_ALIGN_LEFT,baseline:c.TEXT_BASELINE_TOP,initialize:function(a,b,d,c){if(a)this.font=a;if(b)this.size=b;if(d)this.alignment=d;if(c)this.baseline=c},setSize:function(a){this.size=a},setFont:function(a){this.font=a},setAlignment:function(a){this.alignment=
a},setBaseline:function(a){this.baseline=a},setText:function(a){this.text=a},activate:function(a){a.setFont(this.font,this.size);a.setTextAlignment(this.alignment);a.setTextBaseline(this.baseline)},draw:function(a,b,d,c){if(c!=n)this.text=c;this.activate(a);a.drawText(this.text,b,d)}});c.Renderer=c.Class.extend({initialize:function(a){this.ctx=a;this.bFill=!0;this.bStroke=!1;this.bgColor=new c.Color;this.shapePos={x:0,y:0};this.ctx.font="14px serif"},_context:function(a){this.ctx=a},setBackgroundColor:function(a,
b,d,c){this.bgColor.set(a,b,d,c)},clear:function(a,b,d,c){var f=this.ctx.fillStyle;this.ctx.fillStyle=this.bgColor.toRGBAString();this.ctx.fillRect(a,b,d,c);this.ctx.fillStyle=f},setColor:function(a,b,d,c){this.ctx.fillStyle=Pixel.getColorAsRGBAString(a,b,d,c);this.bFill=!0},setColor:function(a){this.ctx.fillStyle=Pixel.getColorAsRGBAString(a.r,a.g,a.b,a.a);this.bFill=!0},setStrokeSize:function(a){this.ctx.lineWidth=a},pushMatrix:function(){this.ctx.save()},popMatrix:function(){this.ctx.restore()},
translate:function(a,b){this.ctx.translate(a,b)},scale:function(a,b){this.ctx.scale(a,b)},rotate:function(a){this.ctx.rotate(c.dToR(a))},setFont:function(a,b){b==n?this.setFont(a.fontFamily,a.size):this.ctx.font=b+"pt "+a;this._setTextAlignment(a.alignment);this._setTextBaseline(a.baseline)},_setTextAlignment:function(a){this.ctx.textAlign=a},_setTextBaseline:function(a){switch(a){case c.TEXT_BASELINE_TOP:this.ctx.textBaseline="top";break;case c.TEXT_BASELINE_MIDDLE:this.ctx.textBaseline="middle";
break;case c.TEXT_BASELINE_BOTTOM:this.ctx.textBaseline="bottom"}},drawText:function(a,b,d){b!=n?this.ctx.fillText(a,b,d):this.ctx.fillText(a,this.cursorX,this.cursorY)},getTextWidth:function(a){return this.ctx.measureText(a).width},drawImageRect:function(a,b,d,c,f){switch(arguments.length){case 1:this.ctx.drawImage(a,0,0);break;case 3:this.ctx.drawImage(a,b,d);break;case 5:this.ctx.drawImage(a,b,d,c,f);break;default:throw Error("Error Arguments !");}},drawImage:function(a,b,d,c,f){switch(arguments.length){case 2:this.ctx.drawImage(a,
b.x,b.y);break;case 3:this.ctx.drawImage(a,b.x,b.y,d.width,d.height);break;case 5:this.ctx.drawImage(a,b.x,b.y,d.width,d.height,c.x,c.y,f.width,f.height);break;default:throw Error("Error Arguments !");}},drawPoint:function(a,b,d){d||(d=1);this.ctx.beginPath();this.ctx.arc(a,b,d,0,Math.PI*2,!1);this.ctx.closePath();this.ctx.fill()},drawPoints:function(a,b,d){if(!(a==null||b==null)){d||(d=1);this.ctx.beginPath();for(var c=0;c<a.length;c++)this.ctx.arc(a[c].x,b[c],d,0,Math.PI*2,!1);this.ctx.closePath();
this.ctx.fill()}},drawPoly:function(a,b,d,c){c=="undefined"&&(c=!1);if(a!=null){if(a.length<3)throw Error("points < 3 !");b=a[0];this._renderContext.beginPath();this._renderContext.moveTo(b.x,b.y);for(i=1;i<a.length;i++)this._renderContext.lineTo(a[i].x,a[i].y);d&&this._renderContext.closePath();c?this._renderContext.fill():this._renderContext.stroke()}},beginShape:function(a,b){this.ctx.beginPath();this.ctx.moveTo(a,b);this.shapePos={x:a,y:b}},addVertex:function(a,b,d){this.ctx.lineTo(a,b);d!=n&&
this.endShape();this.shapePos={x:a,y:b}},curveVertex:function(a,b){var d,c,f,g;d=this.shapePos.x;c=this.shapePos.y;d>a&&c>b||d<a&&c<b?(f=a,g=c):(f=d,g=b);radius=(Math.abs(d-a)+Math.abs(c-b))/2;this.ctx.arcTo(f,g,a,b,radius);this.shapePos={x:a,y:b}},endShape:function(a,b){this.ctx.closePath();this.shapePos={x:a,y:b};this.ctx.fill()},drawLine:function(a,b,d,c){this.ctx.beginPath();this.ctx.moveTo(a,b);this.ctx.lineTo(d,c);this.ctx.stroke()},drawRect:function(a,b,d,c){b!=n?(this.bFill&&this.ctx.fillRect(a,
b,d,c),this.bStroke&&this.ctx.strokeRect(a,b,d,c)):(this.bFill&&this.ctx.fillRect(a.x,a.y,a.width,a.height),this.bStroke&&this.ctx.strokeRect(a.x,a.y,a.width,a.height))},drawRoundedRect:function(a,b,d,c,f){typeof f==="number"&&(f={tl:f,tr:f,br:f,bl:f});this.beginShape();this.addVertex(a+d-f.tr,b);this.curveVertex(a+d,b+f.tr);this.addVertex(a+d,b+c-f.br);this.curveVertex(a+d-f.br,b+c);this.addVertex(a+f.bl,b+c);this.curveVertex(a,b+c-f.bl);this.addVertex(a,b+f.tl);this.curveVertex(a+f.tl,b);this.endShape();
this.bFill&&this.ctx.fill();this.bStroke&&this.ctx.stroke()},drawEllipse:function(a,b,d,c){ox=d/2*0.5522848;oy=c/2*0.5522848;xe=a+d;ye=b+c;xm=a+d/2;ym=b+c/2;this.ctx.beginPath();this.ctx.moveTo(a,ym);this.ctx.bezierCurveTo(a,ym-oy,xm-ox,b,xm,b);this.ctx.bezierCurveTo(xm+ox,b,xe,ym-oy,xe,ym);this.ctx.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);this.ctx.bezierCurveTo(xm-ox,ye,a,ym+oy,a,ym);this.ctx.closePath();this.bStroke&&this.ctx.stroke();this.bFill&&this.ctx.fill()},drawCircle:function(a,b,d){this.ctx.beginPath();
this.ctx.arc(a+d/2,b+d/2,d/2,0,Math.PI*2,!1);this.bStroke&&this.ctx.stroke();this.bFill&&this.ctx.fill()}});c.Time=c.Class.extend({active:!0,delay:0,currentTick:0,initialize:function(a){if(a)this.delay=a},action:function(a){return this.active&&(this.currentTick+=a,this.currentTick>=this.delay)?(this.currentTick-=this.delay,!0):!1},refresh:function(){this.currentTick=0},isActive:function(){return this.active},start:function(){this.active=!0},stop:function(){this.active=!1},getDelay:function(){return this.delay},
setDelay:function(a){this.delay=a;this.refresh()},getCurrentTick:function(){return this.currentTick}});c.Event.LOAD="load";c.Event.PROGRESS="progress";c.Event.ENTER_FRAME="enterframe";c.Event.EXIT_FRAME="exitframe";c.Event.ENTER="enter";c.Event.EXIT="exit";c.Event.CHILD_ADDED="childadded";c.Event.ADDED="added";c.Event.ADDED_TO_SCENE="addedtoScreen";c.Event.CHILD_REMOVED="childremoved";c.Event.REMOVED="removed";c.Event.REMOVED_FROM_SCENE="removedfromScreen";c.Event.TOUCH_START="touchstart";c.Event.TOUCH_MOVE=
"touchmove";c.Event.TOUCH_END="touchend";c.Event.RENDER="render";c.Event.INPUT_START="inputstart";c.Event.INPUT_CHANGE="inputchange";c.Event.INPUT_END="inputend";c.Event.LEFT_BUTTON_DOWN="leftbuttondown";c.Event.LEFT_BUTTON_UP="leftbuttonup";c.Event.RIGHT_BUTTON_DOWN="rightbuttondown";c.Event.RIGHT_fpsBUTTON_UP="rightbuttonup";c.Event.UP_BUTTON_DOWN="upbuttondown";c.Event.UP_BUTTON_UP="upbuttonup";c.Event.DOWN_BUTTON_DOWN="downbuttondown";c.Event.DOWN_BUTTON_UP="downbuttonup";c.Event.A_BUTTON_DOWN=
"abuttondown";c.Event.A_BUTTON_UP="abuttonup";c.Event.B_BUTTON_DOWN="bbuttondown";c.Event.B_BUTTON_UP="bbuttonup";c.Event.ADDED_TO_TIMELINE="addedtotimeline";c.Event.REMOVED_FROM_TIMELINE="removedfromtimeline";c.Event.ACTION_START="actionstart";c.Event.ACTION_END="actionend";c.Event.ACTION_TICK="actiontick";c.Event.ACTION_ADDED="actionadded";c.Event.ACTION_REMOVED="actionremoved";c.EventTarget=c.Class.extend({initialize:function(){this._listeners={}},addEventListener:function(a,b){var d=this._listeners[a];
d==null?this._listeners[a]=[b]:d.indexOf(b)===-1&&d.unshift(b)},on:function(){this.addEventListener.apply(this,arguments)},removeEventListener:function(a,b){var d=this._listeners[a];if(d!=null){var c=d.indexOf(b);c!==-1&&d.splice(c,1)}},clearEventListener:function(a){a!=null?delete this._listeners[a]:this._listeners={}},dispatchEvent:function(a){a.target=this;a.localX=a.x-this._offsetX;a.localY=a.y-this._offsetY;if(this["on"+a.type]!=null)this["on"+a.type](a);var b=this._listeners[a.type];if(b!=null)for(var b=
b.slice(),d=0,c=b.length;d<c;d++)b[d].call(this,a)}});(function(){var a,b,d,e;c.Core=c.Class.extend(c.EventTarget,{_init_context:!1,initialize:function(b,d){if(h.document.body===null)throw Error("document.body is null !");c.EventTarget.call(this);var e=!0;a&&(e=!1,a.exit());a=c.Core.instance=this;this.width=b||320;this.height=d||320;this.scale=1;var j=document.getElementById("lactivity");if(j){var w=h.getComputedStyle(j),b=parseInt(w.width,10),d=parseInt(w.height,10);b&&d?this.scale=Math.min(b/this.width,
d/this.height):(j.style.width=this.width+"px",j.style.height=this.height+"px");for(;j.firstChild;)j.removeChild(j.firstChild);j.style.position="relative";w=j.getBoundingClientRect();this._pageX=Math.round(h.scrollX||h.pageXOffset+w.left);this._pageY=Math.round(h.scrollY||h.pageYOffset+w.top)}else j=document.createElement("div"),j.id="lactivity",j.style.position="absolute",document.body.firstChild?document.body.insertBefore(j,document.body.firstChild):document.body.appendChild(j),this.scale=Math.min(h.innerWidth/
this.width,h.innerHeight/this.height),this._pageY=this._pageX=0;if(!this.scale)this.scale=1;j.style.fontSize="12px";j.style.webkitTextSizeAdjust="none";this._element=j;this.fps=30;this.show_fps=!1;this.frame=0;this.running=this.ready=!1;this.file={};var l=this._file=[];(function q(a){a.file instanceof Array&&[].push.apply(l,a.file);for(var b in a)a.hasOwnProperty(b)&&typeof a[b]==="object"&&a[b]!==null&&Object.getPrototypeOf(a[b])===Object.prototype&&q(a[b])})(c);this._screens=[];this.currentScreen=
null;this.root=new c.Screen;this.pushScreen(this.root);this.loadingScreen=new c.Screen;this.loadingScreen.backgroundColor="#000";var m=this.width*0.4|0,o=this.width*0.05|0,r=m*0.03|0,j=new c.Sprite(m,o);j.x=(this.width-m)/2;j.y=(this.height-o)/2;var n=new c.Bitmap(m,o);n.context.fillStyle="#fff";n.context.fillRect(0,0,m,o);n.context.fillStyle="#000";n.context.fillRect(r,r,m-r*2,o-r*2);j.image=n;var p=0,s=0;this.addEventListener("progress",function(a){p=a.loaded/a.total});j.addEventListener("enterframe",
function(){s*=0.9;s+=p*0.1;n.context.fillStyle="#fff";n.context.fillRect(r,0,(m-r*2)*s,o)});this.loadingScreen.addChild(j);this._soundID=this._surfaceID=this._mousedownID=0;this._activated=!1;this._offsetY=this._offsetX=0;this.input={};if(!c.System.KEY_BIND_TABLE)c.System.KEY_BIND_TABLE={};this._keybind=c.System.KEY_BIND_TABLE;this.pressedKeysNum=0;this._internalButtondownListeners={};this._internalButtonupListeners={};for(var t in this._keybind)this.keybind(t,this._keybind[t]);if(e){var j=c.Core.instance._element,
u;document.addEventListener("keydown",function(b){a.dispatchEvent(new c.Event("keydown"));c.System.PREVENT_DEFAULT_KEY_CODES.indexOf(b.keyCode)!==-1&&(b.preventDefault(),b.stopPropagation());if(a.running&&(b=a._keybind[b.keyCode]))u=new c.Event(b+"buttondown"),a.dispatchEvent(u)},!0);document.addEventListener("keyup",function(b){if(a.running&&(b=a._keybind[b.keyCode]))u=new c.Event(b+"buttonup"),a.dispatchEvent(u)},!0);c.System.SUPPORT_TOUCH&&(j.addEventListener("touchstart",function(b){var d=b.target.tagName.toLowerCase();
c.System.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(b.preventDefault(),a.running||b.stopPropagation())},!0),j.addEventListener("touchmove",function(b){var d=b.target.tagName.toLowerCase();c.System.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(b.preventDefault(),a.running||b.stopPropagation())},!0),j.addEventListener("touchend",function(b){var d=b.target.tagName.toLowerCase();c.System.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(b.preventDefault(),a.running||b.stopPropagation())},!0));j.addEventListener("mousedown",
function(b){var d=b.target.tagName.toLowerCase();c.System.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(b.preventDefault(),a._mousedownID++,a.running||b.stopPropagation())},!0);j.addEventListener("mousemove",function(b){var d=b.target.tagName.toLowerCase();c.System.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(b.preventDefault(),a.running||b.stopPropagation())},!0);j.addEventListener("mouseup",function(b){var d=b.target.tagName.toLowerCase();c.System.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(b.preventDefault(),
a.running||b.stopPropagation())},!0);a._touchEventTarget={};c.System.SUPPORT_TOUCH&&(j.addEventListener("touchstart",function(a){for(var b=c.Core.instance,d=new c.Event(c.Event.TOUCH_START),a=a.changedTouches,e,f,g=0,k=a.length;g<k;g++)e=a[g],d._initPosition(e.pageX,e.pageY),f=b.currentScreen._determineEventTarget(d),b._touchEventTarget[e.identifier]=f,f.dispatchEvent(d)},!1),j.addEventListener("touchmove",function(a){for(var b=c.Core.instance,d=new c.Event(c.Event.TOUCH_MOVE),a=a.changedTouches,
e,f,g=0,k=a.length;g<k;g++)if(e=a[g],f=b._touchEventTarget[e.identifier])d._initPosition(e.pageX,e.pageY),f.dispatchEvent(d)},!1),j.addEventListener("touchend",function(a){for(var b=c.Core.instance,d=new c.Event(c.Event.TOUCH_END),a=a.changedTouches,e,f,g=0,k=a.length;g<k;g++)if(e=a[g],f=b._touchEventTarget[e.identifier])d._initPosition(e.pageX,e.pageY),f.dispatchEvent(d),delete b._touchEventTarget[e.identifier]},!1));j.addEventListener("mousedown",function(a){var b=c.Core.instance,d=new c.Event(c.Event.TOUCH_START);
d._initPosition(a.pageX,a.pageY);a=b.currentScreen._determineEventTarget(d);b._touchEventTarget[b._mousedownID]=a;a.dispatchEvent(d)},!1);j.addEventListener("mousemove",function(a){var b=c.Core.instance,d=new c.Event(c.Event.TOUCH_MOVE);d._initPosition(a.pageX,a.pageY);(a=b._touchEventTarget[b._mousedownID])&&a.dispatchEvent(d)},!1);j.addEventListener("mouseup",function(a){var b=c.Core.instance,d=new c.Event(c.Event.TOUCH_END);d._initPosition(a.pageX,a.pageY);b._touchEventTarget[b._mousedownID].dispatchEvent(d);
delete b._touchEventTarget[b._mousedownID]},!1)}},preload:function(a){a instanceof Array||(a=Array.prototype.slice.call(arguments));[].push.apply(this._file,a)},load:function(b,d){d==null&&(d=function(){});var e=c.Core.findExt(b);if(c.Core._loadFuncs[e])c.Core._loadFuncs[e].call(this,b,d,e);else{var j=h.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Msxml2.XMLHTTP");j.open("GET",b,!0);j.onreadystatechange=function(){if(j.readyState===4){if(j.status!==200&&j.status!==0)throw Error(j.status+": Cannot load an asset: "+
b);var e=j.getResponseHeader("Content-Type")||"";e.match(/^image/)?(a.file[b]=c.Bitmap.load(b),a.file[b].addEventListener("load",d)):e.match(/^audio/)?(a.file[b]=c.Sound.load(b,e),a.file[b].addEventListener("load",d)):(a.file[b]=j.responseText,d())}};j.send(null)}},show:function(){var e=function(){this._nextTime=this.currentTime=0;this.removeEventListener("load",e);this.ready=this.running=!0;this._requestNextFrame()};if(this.show_fps&&(b=document.getElementById("lfps"),!b))b=document.createElement("div"),
b.id="lfps",b.style.position="absolute",b.style.left="5px",b.style.top="5px",b.style.fontSize="20px",b.style.fontFamily="Arial",b.style.display="block",document.body.appendChild(b);d||(d=new c.Time(1E3));this.addEventListener("load",e);if(!this._activated&&this._file.length)if(this._activated=!0,c.Sound.enabledInMobileSafari&&!a._touched&&c.System.BROWSER==="webkit"&&c.System.SUPPORT_TOUCH){var g=new c.Screen;g.backgroundColor="#000";var k=Math.round(a.width/10),j=new c.Sprite(a.width,k);j.y=(a.height-
k)/2;j.image=new c.Bitmap(a.width,k);j.image.context.fillStyle="#fff";j.image.context.font=k-1+"px bold Helvetica,Arial,sans-serif";var h=j.image.context.measureText("Touch to Start").width;j.image.context.fillText("Touch to Start",(a.width-h)/2,k-1);g.addChild(j);document.addEventListener("touchstart",function(){a._touched=!0;a.removeScreen(g);a.show()},!0);a.pushScreen(g)}else{var l={},k=this._file.filter(function(a){return a in l?!1:l[a]=!0}),m=0,o=k.length,j=function(){var b=new c.Event("progress");
b.loaded=++m;b.total=o;a.dispatchEvent(b);m===o&&(a.removeScreen(a.loadingScreen),a.dispatchEvent(new c.Event("load")))},h=0;for(;h<o;h++)this.load(k[h],j);this.pushScreen(this.loadingScreen)}else this.dispatchEvent(new c.Event("load"))},_requestNextFrame:function(){this.ready&&h.requestFrame(this._checkTick)},_checkTick:function(a){var b=c.Core.instance;b._nextTime<a?b._tick(a):h.requestFrame(b._checkTick)},_tick:function(a){var g=new c.Event("enterframe");g.elapsed=this.currentTime===0?0:a-this.currentTime;
this._nextTime=a+1E3/this.fps;this.currentTime=a;this._actualFps=g.elapsed>0?1E3/g.elapsed:0;for(var a=this.currentScreen.childNodes.slice(),k=Array.prototype.push;a.length;){var j=a.pop();j.age++;j.dispatchEvent(g);j.childNodes&&k.apply(a,j.childNodes)}this.currentScreen.age++;this.currentScreen.dispatchEvent(g);this.dispatchEvent(g);this.dispatchEvent(new c.Event("exitframe"));this.frame++;config.useCanvasUpdate&&this.ready&&this.root._context&&(this._init_context||(e==null?e=new c.Renderer(this.root._context):
e._context(this.root._context),_init_context=!0),OnUpdate(e,g.elapsed));if(this.show_fps&&d.action(g.elapsed)&&b&&this._actualFps!=this.fps)b.innerHTML="<strong>FPS:"+Math.round(this._actualFps||this.fps)+"</strong>";this._requestNextFrame()},getTime:function(){return h.getTime()},exit:function(){this._init_context=this.running=this.ready=!1},pause:function(){this.ready=!1},resume:function(){if(!this.ready)this.currentTime=0,this.running=this.ready=!0,this._requestNextFrame()},setFPS:function(a){this.fps=
a},getFPS:function(){return this.fps},setShowFPS:function(a){this.show_fps=a},getShowFPS:function(){return this.show_fps},pushScreen:function(a){this._element.appendChild(a._element);this.currentScreen&&this.currentScreen.dispatchEvent(new c.Event("exit"));this.currentScreen=a;this.currentScreen.dispatchEvent(new c.Event("enter"));return this._screens.push(a)},popScreen:function(){if(this.currentScreen===this.root)return this.currentScreen;this._element.removeChild(this.currentScreen._element);this.currentScreen.dispatchEvent(new c.Event("exit"));
this.currentScreen=this._screens[this._screens.length-2];this.currentScreen.dispatchEvent(new c.Event("enter"));return this._screens.pop()},replaceScreen:function(a){this.popScreen();return this.pushScreen(a)},removeScreen:function(a){if(this.currentScreen===a)return this.popScreen();else{var b=this._screens.indexOf(a);return b!==-1?(this._screens.splice(b,1),this._element.removeChild(a._element),a):null}},keybind:function(a,b){this._keybind[a]=b;var d=function(a){var d;this.input[b]||(this.input[b]=
!0,d=new c.Event(this.pressedKeysNum++?"inputchange":"inputstart"),this.dispatchEvent(d),this.currentScreen.dispatchEvent(d));this.currentScreen.dispatchEvent(a)},e=function(a){var d;this.input[b]&&(this.input[b]=!1,d=new c.Event(--this.pressedKeysNum?"inputchange":"inputend"),this.dispatchEvent(d),this.currentScreen.dispatchEvent(d));this.currentScreen.dispatchEvent(a)};this.addEventListener(b+"buttondown",d);this.addEventListener(b+"buttonup",e);this._internalButtondownListeners[a]=d;this._internalButtonupListeners[a]=
e},keyunbind:function(a){if(this._keybind[a]){var b=this._internalButtondownListeners,d=this._internalButtonupListeners;this.removeEventListener(a+"buttondown",b);this.removeEventListener(a+"buttonup",d);delete b[a];delete d[a];delete this._keybind[a]}},getElapsedTime:function(){return this.frame/this.fps}});c.Core._loadFuncs={};c.Core._loadFuncs.jpg=c.Core._loadFuncs.jpeg=c.Core._loadFuncs.gif=c.Core._loadFuncs.png=c.Core._loadFuncs.bmp=function(a,b){this.file[a]=c.Bitmap.load(a);this.file[a].addEventListener("load",
b)};c.Core._loadFuncs.mp3=c.Core._loadFuncs.aac=c.Core._loadFuncs.m4a=c.Core._loadFuncs.wav=c.Core._loadFuncs.ogg=function(a,b,d){this.file[a]=c.Sound.load(a,"audio/"+d,b)};c.Core.findExt=function(a){var b=a.match(/\.\w+$/);return b&&b.length>0?b[0].slice(1).toLowerCase():a.indexOf("data:")===0?a.split(/[\/;]/)[1].toLowerCase():null};c.Core.instance=null})();c.Node=c.Class.extend(c.EventTarget,{initialize:function(){c.EventTarget.call(this);this._dirty=!1;this._matrix=[1,0,0,1,0,0];this.age=this._offsetY=
this._offsetX=this._y=this._x=0;this.screen=this.parentNode=null;this.addEventListener("touchstart",function(a){this.parentNode&&this.parentNode.dispatchEvent(a)});this.addEventListener("touchmove",function(a){this.parentNode&&this.parentNode.dispatchEvent(a)});this.addEventListener("touchend",function(a){this.parentNode&&this.parentNode.dispatchEvent(a)});if(c.System.USE_ANIMATION)this.tl=new c.Timeline(this)},moveTo:function(a,b){this._x=a;this._y=b;this._dirty=!0},moveBy:function(a,b){this._x+=
a;this._y+=b;this._dirty=!0},x:{get:function(){return this._x},set:function(a){this._x=a;this._dirty=!0}},y:{get:function(){return this._y},set:function(a){this._y=a;this._dirty=!0}},_updateCoordinate:function(){for(var a=this,b=[a],d=a.parentNode;d&&a._dirty;)b.unshift(d),a=a.parentNode,d=a.parentNode;var d=c.Matrix.instance,e=d.stack,f=[],g,k,j;e.push(b[0]._matrix);for(var h=1,l=b.length;h<l;h++){a=b[h];g=[];d.makeTransformMatrix(a,f);d.multiply(e[e.length-1],f,g);a._matrix=g;e.push(g);k=typeof a._originX===
"number"?a._originX:a._width/2||0;j=typeof a._originY==="number"?a._originY:a._height/2||0;var m=[k,j];d.multiplyVec(g,m,m);a._offsetX=m[0]-k;a._offsetY=m[1]-j;a._dirty=!1}d.reset()},remove:function(){this._listener&&this.clearEventListener();this.parentNode&&this.parentNode.removeChild(this)}});var B=function(a,b){for(var d=[],c,f=0,g=a.collection.length;f<g;f++)c=a.collection[f],b._intersectone(c)&&d.push(c);return d},H=function(a){if(a instanceof c.Entity)return B(this,a);else if(typeof a==="function"&&
a.collection){for(var b=[],d,e,f=0,g=this.collection.length;f<g;f++){d=this.collection[f];for(var k=0,j=a.collection.length;k<j;k++)e=a.collection[k],d._intersectone(e)&&b.push([d,e])}return b}return!1};c.Entity=c.Class.extend(c.Node,{initialize:function(){var a=c.Core.instance;c.Node.call(this);this._rotation=0;this._scaleY=this._scaleX=1;this._touchEnabled=!0;this._clipping=!1;this._originY=this._originX=null;this._height=this._width=0;this._backgroundColor=null;this._opacity=1;this._visible=!0;
this._buttonMode=null;this._style={};this.__styleStatus={};this.buttonMode=this.compositeOperation=null;this.buttonPressed=!1;this.addEventListener("touchstart",function(){if(this.buttonMode){this.buttonPressed=!0;var b=new c.Event(this.buttonMode+"buttondown");this.dispatchEvent(b);a.dispatchEvent(b)}});this.addEventListener("touchend",function(){if(this.buttonMode){this.buttonPressed=!1;var b=new c.Event(this.buttonMode+"buttonup");this.dispatchEvent(b);a.dispatchEvent(b)}});this.enableCollection()},
width:{get:function(){return this._width},set:function(a){this._width=a;this._dirty=!0}},height:{get:function(){return this._height},set:function(a){this._height=a;this._dirty=!0}},backgroundColor:{get:function(){return this._backgroundColor},set:function(a){this._backgroundColor=a}},opacity:{get:function(){return this._opacity},set:function(a){this._opacity=parseFloat(a)}},visible:{get:function(){return this._visible},set:function(a){this._visible=a}},touchEnabled:{get:function(){return this._touchEnabled},
set:function(a){this._touchEnabled=a;this._style.pointerEvents=a?"all":"none"}},intersect:function(a){if(a instanceof c.Entity)return this._intersectone(a);else if(typeof a==="function"&&a.collection)return B(a,this);return!1},_intersectone:function(a){this._dirty&&this._updateCoordinate();a._dirty&&a._updateCoordinate();return this._offsetX<a._offsetX+a.width&&a._offsetX<this._offsetX+this.width&&this._offsetY<a._offsetY+a.height&&a._offsetY<this._offsetY+this.height},within:function(a,b){this._dirty&&
this._updateCoordinate();a._dirty&&a._updateCoordinate();b==null&&(b=(this.width+this.height+a.width+a.height)/4);var d;return(d=this._offsetX-a._offsetX+(this.width-a.width)/2)*d+(d=this._offsetY-a._offsetY+(this.height-a.height)/2)*d<b*b},scale:function(a,b){this._scaleX*=a;this._scaleY*=b!=null?b:a;this._dirty=!0},rotate:function(a){this._rotation+=a;this._dirty=!0},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX=a;this._dirty=!0}},scaleY:{get:function(){return this._scaleY},
set:function(a){this._scaleY=a;this._dirty=!0}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation=a;this._dirty=!0}},originX:{get:function(){return this._originX},set:function(a){this._originX=a;this._dirty=!0}},originY:{get:function(){return this._originY},set:function(a){this._originY=a;this._dirty=!0}},enableCollection:function(){this.addEventListener("addedtoscreen",this._addSelfToCollection);this.addEventListener("removedfromscreen",this._removeSelfFromCollection);
this.screen&&this._addSelfToCollection()},disableCollection:function(){this.removeEventListener("addedtoscreen",this._addSelfToCollection);this.removeEventListener("removedfromscreen",this._removeSelfFromCollection);this.screen&&this._removeSelfFromCollection()},_addSelfToCollection:function(){this.getConstructor()._collectionTarget.forEach(function(a){a.collection.push(this)},this)},_removeSelfFromCollection:function(){this.getConstructor()._collectionTarget.forEach(function(a){var b=a.collection.indexOf(this);
b!==-1&&a.collection.splice(b,1)},this)},getConstructor:function(){return Object.getPrototypeOf(this).constructor}});var C=function(a){if(!a._collective){var b=c.Class.getSupers(a),d=b.indexOf(c.Entity);a._collectionTarget=d!==-1?b.splice(0,d+1):[];a.intersect=H;a.collection=[];a._collective=!0}};C(c.Entity);c.Entity._inherited=function(a){C(a)};c.Sprite=c.Class.extend(c.Entity,{initialize:function(a,b){c.Entity.call(this);this.width=a;this.height=b;this._image=null;this._frame=this._frameTop=this._frameLeft=
0;this._frameSequence=[];this.addEventListener("enterframe",function(){if(this._frameSequence.length!==0){var a=this._frameSequence.shift();a===null?this._frameSequence=[]:(this._setFrame(a),this._frameSequence.push(a))}})},image:{get:function(){return this._image},set:function(a){if(a!==this._image)this._image=a,this._setFrame(this._frame)}},frame:{get:function(){return this._frame},set:function(a){if(this._frame!==a)if(a instanceof Array){var b=a.shift();this._setFrame(b);a.push(b);this._frameSequence=
a}else this._setFrame(a),this._frameSequence=[],this._frame=a}},_setFrame:function(a){var b=this._image,d;if(b!=null)this._frame=a,d=b.width/this._width|0,this._frameLeft=(a%d|0)*this._width,this._frameTop=(a/d|0)*this._height%b.height},width:{get:function(){return this._width},set:function(a){this._width=a;this._setFrame();this._dirty=!0}},height:{get:function(){return this._height},set:function(a){this._height=a;this._setFrame();this._dirty=!0}},cvsRender:function(a){if(!(this._image==null||this._width===
0||this._height===0)){var b=this._image,d=b._element,c=this._frameLeft,f=this._frameTop,g=Math.min(this.width,b.width-c),k=Math.min(this.height,b.height-f),j=Math.min(b.width,this.width),b=Math.min(b.height,this.height),h,l,m,o;for(l=0;l<this.height;l+=b){o=this.height<l+b?this.height-l:b;for(h=0;h<this.width;h+=j)m=this.width<h+j?this.width-h:j,a.drawImage(d,c,f,g*m/j,k*o/b,h,l,m,o)}}},domRender:function(){if(this._image&&this._image._css)this._style["background-image"]=this._image._css,this._style["background-position"]=
-this._frameLeft+"px "+-this._frameTop+"px"}});c.Label=c.Class.extend(c.Entity,{initialize:function(a){c.Entity.call(this);this.text=a||"";this.width=300;this.font="14px serif";this.textAlign="left"},text:{get:function(){return this._text},set:function(a){if(this._text!==a){this._text=a;a=a.replace(/<(br|BR) ?\/?>/g,"<br/>");this._splitText=a.split("<br/>");this.updateBoundArea();for(var b=0,d=this._splitText.length;b<d;b++){var a=this._splitText[b],c=this.getMetrics(a);this._splitText[b]={};this._splitText[b].text=
a;this._splitText[b].height=c.height}}}},textAlign:{get:function(){return this._style["text-align"]},set:function(a){this._style["text-align"]=a;this.updateBoundArea()}},font:{get:function(){return this._style.font},set:function(a){this._style.font=a;this.updateBoundArea()}},color:{get:function(){return this._style.color},set:function(a){this._style.color=a}},cvsRender:function(a){var b,d=0,c=this.width,f,g,k,j,h,l;if(this._splitText){a.textBaseline="top";a.font=this.font;a.fillStyle=this.color||
"#000000";f=a.measureText(" ").width;f=c/f;for(var m=0,o=this._splitText.length;m<o;m++){g=this._splitText[m];b=g.text;for(k=0;b.length>k+f||a.measureText(b.slice(k,k+f)).width>c;){j="";h=f;for(l=0;h>0;)a.measureText(j).width<c?l+=h:l-=h,j=b.slice(k,k+l),h=h/2|0;a.fillText(j,0,d);d+=g.height-1;k+=l}j=b.slice(k,k+b.length);b=this.textAlign==="right"?c-a.measureText(j).width:this.textAlign==="center"?(c-a.measureText(j).width)/2:0;a.fillText(j,b,d);d+=g.height-1}}},domRender:function(a){if(a.innerHTML!==
this._text)a.innerHTML=this._text},detectRender:function(a){a.fillRect(this._boundOffset,0,this._boundWidth,this._boundHeight)},updateBoundArea:function(){var a=this.getMetrics();this._boundWidth=a.width;this._boundHeight=a.height;this._boundOffset=this.textAlign==="right"?this.width-this._boundWidth:this.textAlign==="center"?(this.width-this._boundWidth)/2:0}});c.Label.prototype.getMetrics=function(a){var b={},d;if(document.body){d=document.createElement("div");for(var c in this._style)c!=="width"&&
c!=="height"&&(d.style[c]=this._style[c]);a=a||this._text;d.innerHTML=a.replace(/ /g,"&nbsp;");d.style.whiteSpace="noWrap";document.body.appendChild(d);b.height=parseInt(getComputedStyle(d).height,10)+1;d.style.position="absolute";b.width=parseInt(getComputedStyle(d).width,10)+1;document.body.removeChild(d)}else b.width=this.width,b.height=this.height;return b};c.Map=c.Class.extend(c.Entity,{initialize:function(a,b){var d=c.Core.instance;c.Entity.call(this);var e=new c.Bitmap(d.width,d.height);this._surface=
e;e=e._element;e.style.position="absolute";c.System.RETINA_IOS_DISPLAY&&d.scale===2?(e.width=d.width*2,e.height=d.height*2,this._style.webkitTransformOrigin="0 0",this._style.webkitTransform="scale(0.5)"):(e.width=d.width,e.height=d.height);this._context=e.getContext("2d");this._tileWidth=a||0;this._tileHeight=b||0;this._image=null;this._data=[[[]]];this.touchEnabled=this._tight=this._dirty=!1;this.collisionData=null;this._listeners.render=null;this.addEventListener("render",function(){if(this._dirty||
this._previousOffsetX==null)this.redraw(0,0,d.width,d.height);else if(this._offsetX!==this._previousOffsetX||this._offsetY!==this._previousOffsetY)if(this._tight){var a=-this._offsetX,b=-this._offsetY,c=-this._previousOffsetX,e=-this._previousOffsetY,h=a-c+d.width,l=c-a+d.width,m=b-e+d.height,o=e-b+d.height;if(h>this._tileWidth&&l>this._tileWidth&&m>this._tileHeight&&o>this._tileHeight){var n;h<l?(n=0,a=c-a,l=h):(n=a-c,a=0);m<o?(h=0,b=e-b):(h=b-e,b=0,m=o);if(d._buffer==null)d._buffer=document.createElement("canvas"),
d._buffer.width=this._context.canvas.width,d._buffer.height=this._context.canvas.height;o=d._buffer.getContext("2d");this._doubledImage?(o.clearRect(0,0,l*2,m*2),o.drawImage(this._context.canvas,n*2,h*2,l*2,m*2,0,0,l*2,m*2),o=this._context,o.clearRect(a*2,b*2,l*2,m*2),o.drawImage(d._buffer,0,0,l*2,m*2,a*2,b*2,l*2,m*2)):(o.clearRect(0,0,l,m),o.drawImage(this._context.canvas,n,h,l,m,0,0,l,m),o=this._context,o.clearRect(a,b,l,m),o.drawImage(d._buffer,0,0,l,m,a,b,l,m));a===0?this.redraw(l,0,d.width-l,
d.height):this.redraw(0,0,d.width-l,d.height);b===0?this.redraw(0,m,d.width,d.height-m):this.redraw(0,0,d.width,d.height-m)}else this.redraw(0,0,d.width,d.height)}else this.redraw(0,0,d.width,d.height);this._previousOffsetX=this._offsetX;this._previousOffsetY=this._offsetY})},loadData:function(a){this._data=Array.prototype.slice.apply(arguments);this._dirty=!0;this._tight=!1;for(var b=0,d=this._data.length;b<d;b++){for(var c=0,a=this._data[b],f=0,g=a.length;f<g;f++)for(var k=0,j=a[f].length;k<j;k++)a[f][k]>=
0&&c++;if(c/(a.length*a[0].length)>0.2){this._tight=!0;break}}},checkTile:function(a,b){if(a<0||this.width<=a||b<0||this.height<=b)return!1;var d=this._image.width,c=this._image.height,c=this._tileHeight||c,a=a/(this._tileWidth||d)|0;return this._data[0][b/c|0][a]},hit:function(a,b){if(a<0||this.width<=a||b<0||this.height<=b)return!1;var d=this._image.width,c=this._image.height,f=this._tileWidth||d,g=this._tileHeight||c,a=a/f|0,b=b/g|0;if(this.collisionData!=null)return this.collisionData[b]&&!!this.collisionData[b][a];
else{for(var k=0,j=this._data.length;k<j;k++){var h=this._data[k],l;if(h[b]!=null&&(l=h[b][a])!=null&&0<=l&&l<(d/f|0)*(c/g|0))return!0}return!1}},image:{get:function(){return this._image},set:function(a){var b=c.Core.instance;this._image=a;if(c.System.RETINA_IOS_DISPLAY&&b.scale===2){for(var b=new c.Bitmap(a.width*2,a.height*2),d=this._tileWidth||a.width,e=this._tileHeight||a.height,f=a.width/d|0,g=a.height/e|0,k=0;k<g;k++)for(var j=0;j<f;j++)b.draw(a,j*d,k*e,d,e,j*d*2,k*e*2,d*2,e*2);this._doubledImage=
b}this._dirty=!0}},tileWidth:{get:function(){return this._tileWidth},set:function(a){this._tileWidth=a;this._dirty=!0}},tileHeight:{get:function(){return this._tileHeight},set:function(a){this._tileHeight=a;this._dirty=!0}},width:{get:function(){return this._tileWidth*this._data[0][0].length}},height:{get:function(){return this._tileHeight*this._data[0].length}},redraw:function(a,b,d,c){if(this._image!=null){var f,g,k,j,h;this._doubledImage?(f=this._doubledImage,g=this._tileWidth*2,k=this._tileHeight*
2,j=-this._offsetX*2,h=-this._offsetY*2,a*=2,b*=2,d*=2,c*=2):(f=this._image,g=this._tileWidth,k=this._tileHeight,j=-this._offsetX,h=-this._offsetY);var l=f.width/g|0,m=f.height/k|0,o=Math.max((a+j)/g|0,0),n=Math.max((b+h)/k|0,0),p=Math.ceil((a+j+d)/g),v=Math.ceil((b+h+c)/k);f=f._element;var s=this._context;s.clearRect(a,b,d,c);d=0;for(c=this._data.length;d<c;d++)for(var t=this._data[d],u=Math.min(p,t[0].length),x=Math.min(v,t.length),b=n;b<x;b++)for(a=o;a<u;a++){var q=t[b][a];0<=q&&q<l*m&&s.drawImage(f,
q%l*g,(q/l|0)*k,g,k,a*g-j,b*k-h,g,k)}}},cvsRender:function(a){var b=c.Core.instance;this.width!==0&&this.height!==0&&(a.save(),a.setTransform(1,0,0,1,0,0),a.drawImage(this._context.canvas,0,0,b.width,b.height),a.restore())},domRender:function(){if(this._image)this._style["background-image"]=this._surface._css,this._style[c.System.BROWSER+"Transform"]="matrix(1, 0, 0, 1, 0, 0)"}});c.Group=c.Class.extend(c.Node,{initialize:function(){this.childNodes=[];c.Node.call(this);this._rotation=0;this._scaleY=
this._scaleX=1;this._originY=this._originX=null;this.__dirty=!1;[c.Event.ADDED_TO_SCENE,c.Event.REMOVED_FROM_SCENE].forEach(function(a){this.addEventListener(a,function(a){this.childNodes.forEach(function(d){d.screen=this.screen;d.dispatchEvent(a)},this)})},this)},addChild:function(a){this.childNodes.push(a);a.parentNode=this;var b=new c.Event("childadded");b.node=a;b.next=null;this.dispatchEvent(b);a.dispatchEvent(new c.Event("added"));if(this.screen)a.screen=this.screen,b=new c.Event("addedtoscreen"),
a.dispatchEvent(b)},insertBefore:function(a,b){var d=this.childNodes.indexOf(b);if(d!==-1){if(this.childNodes.splice(d,0,a),a.parentNode=this,d=new c.Event("childadded"),d.node=a,d.next=b,this.dispatchEvent(d),a.dispatchEvent(new c.Event("added")),this.screen)a.screen=this.screen,d=new c.Event("addedtoscreen"),a.dispatchEvent(d)}else this.addChild(a)},removeChild:function(a){var b;if((b=this.childNodes.indexOf(a))!==-1)if(this.childNodes.splice(b,1),a.parentNode=null,b=new c.Event("childremoved"),
b.node=a,this.dispatchEvent(b),a.dispatchEvent(new c.Event("removed")),this.screen)a.screen=null,b=new c.Event("removedfromscreen"),a.dispatchEvent(b)},firstChild:{get:function(){return this.childNodes[0]}},lastChild:{get:function(){return this.childNodes[this.childNodes.length-1]}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation=a;this._dirty=!0}},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX=a;this._dirty=!0}},scaleY:{get:function(){return this._scaleY},
set:function(a){this._scaleY=a;this._dirty=!0}},originX:{get:function(){return this._originX},set:function(a){this._originX=a;this._dirty=!0}},originY:{get:function(){return this._originY},set:function(a){this._originY=a;this._dirty=!0}},_dirty:{get:function(){return this.__dirty},set:function(a){if(this.__dirty=a=!!a)for(var a=0,b=this.childNodes.length;a<b;a++)this.childNodes[a]._dirty=!0}}});c.Matrix=c.Class.extend({initialize:function(){if(c.Matrix.instance)return c.Matrix.instance;this.reset()},
reset:function(){this.stack=[];this.stack.push([1,0,0,1,0,0])},makeTransformMatrix:function(a,b){var d=a._x,c=a._y,f=a.width||0,g=a.height||0,k=typeof a._scaleX==="number"?a._scaleX:1,j=typeof a._scaleY==="number"?a._scaleY:1,h=(a._rotation||0)*Math.PI/180,l=Math.cos(h),h=Math.sin(h),f=typeof a._originX==="number"?a._originX:f/2,g=typeof a._originY==="number"?a._originY:g/2,m=k*l;k*=h;h*=j;j*=l;b[0]=m;b[1]=k;b[2]=-h;b[3]=j;b[4]=-m*f+h*g+d+f;b[5]=-k*f-j*g+c+g},multiply:function(a,b,d){var c=a[0],f=
a[2],g=a[4],k=a[1],j=a[3],a=a[5],h=b[0],l=b[2],m=b[4],o=b[1],n=b[3],b=b[5];d[0]=c*h+f*o;d[1]=k*h+j*o;d[2]=c*l+f*n;d[3]=k*l+j*n;d[4]=c*m+f*b+g;d[5]=k*m+j*b+a},multiplyVec:function(a,b,d){var c=b[0],b=b[1],f=a[1],g=a[3],k=a[5];d[0]=a[0]*c+a[2]*b+a[4];d[1]=f*c+g*b+k}});c.Matrix.instance=new c.Matrix;c.ColorManager=c.Class.extend({initialize:function(a,b){this.reference=[];this.colorResolution=a||16;this.max=b||1;this.capacity=Math.pow(this.colorResolution,3);for(var d=1,c=this.capacity;d<c;d++)this.reference[d]=
null},attachDetectColor:function(a){var b=this.reference.indexOf(null);b===-1&&(b=1);this.reference[b]=a;return this._getColor(b)},detachDetectColor:function(a){a=this.reference.indexOf(a);a!==-1&&(this.reference[a]=null)},_getColor:function(a){var b=this.colorResolution,d=b/this.max;return[parseInt(a/b/b%b,10)/d,parseInt(a/b%b,10)/d,parseInt(a%b,10)/d,1]},_decodeDetectColor:function(a){var b=this.colorResolution;return~~(a[0]*b*b*b/256)+~~(a[1]*b*b/256)+~~(a[2]*b/256)},getSpriteByColor:function(a){return this.reference[this._decodeDetectColor(a)]}});
c.CanvasLayer=c.Class.extend(c.Group,{initialize:function(){var a=c.Core.instance;c.Group.call(this);this._cvsCache={matrix:[1,0,0,1,0,0],detectColor:"#000000"};this._cvsCache.layer=this;this.width=a.width;this.height=a.height;this._element=document.createElement("canvas");this._element.width=a.width;this._element.height=a.height;this._element.style.position="absolute";this._detect=document.createElement("canvas");this._detect.width=a.width;this._detect.height=a.height;this._detect.style.position=
"absolute";this._lastDetected=0;this.context=this._element.getContext("2d");this._dctx=this._detect.getContext("2d");this._colorManager=new c.ColorManager(16,256);[c.Event.TOUCH_START,c.Event.TOUCH_MOVE,c.Event.TOUCH_END].forEach(function(a){this.addEventListener(a,function(a){this._screen&&this._screen.dispatchEvent(a)})},this);var b=function(a){var f=a.node,a=a.target,g;g=a instanceof c.CanvasLayer?a._screen._layers.Canvas:a.screen._layers.Canvas;c.CanvasLayer._attachCache(f,g,b,d);var k=new c.Event(c.Event.RENDER);
a._dirty&&a._updateCoordinate();f._dirty=!0;c.Matrix.instance.stack.push(a._matrix);g._rendering(f,k);c.Matrix.instance.stack.pop(a._matrix)},d=function(a){var f=a.target;c.CanvasLayer._detachCache(a.node,f instanceof c.CanvasLayer?f._screen._layers.Canvas:f.screen._layers.Canvas,b,d)};this.addEventListener("childremoved",d);this.addEventListener("childadded",b)},getContext:function(){return this.context},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe);this._onexitframe(new c.Event(c.Event.RENDER))},
_stopRendering:function(){this.removeEventListener("render",this._onexitframe);this._onexitframe(new c.Event(c.Event.RENDER))},_onexitframe:function(){var a=c.Core.instance;this.context.clearRect(0,0,a.width,a.height);this._rendering(this,new c.Event(c.Event.RENDER))},_rendering:function(a,b){var d=a.width,e=a.height,f=this.context;f.save();a.dispatchEvent(b);f.globalCompositeOperation=a.compositeOperation?a.compositeOperation:"source-over";f.globalAlpha=typeof a._opacity==="number"?a._opacity:1;
this._transform(a,f);if(typeof a._visible==="undefined"||a._visible){if(a._backgroundColor)f.fillStyle=a._backgroundColor,f.fillRect(0,0,d,e);a.cvsRender&&a.cvsRender(f);a._clipping&&(f.rect(0,0,d,e),f.clip())}if(a.childNodes)for(var e=0,g=a.childNodes.length;e<g;e++)d=a.childNodes[e],this._rendering(d,b);f.restore();c.Matrix.instance.stack.pop()},_detectrendering:function(a){var b=a.width,d=a.height,e=this._dctx;e.save();this._transform(a,e);e.fillStyle=a._cvsCache.detectColor;a._touchEnabled&&(a.detectRender?
a.detectRender(e):e.fillRect(0,0,b,d));a._clipping&&(e.rect(0,0,b,d),e.clip());if(a.childNodes)for(var d=0,f=a.childNodes.length;d<f;d++)b=a.childNodes[d],this._detectrendering(b);e.restore();c.Matrix.instance.stack.pop()},_transform:function(a,b){var d=c.Matrix.instance,e=d.stack,f;a._dirty?(d.makeTransformMatrix(a,a._cvsCache.matrix),f=[],d.multiply(e[e.length-1],a._cvsCache.matrix,f),a._matrix=f):f=a._matrix;e.push(f);b.setTransform.apply(b,f);var e=typeof a._originX==="number"?a._originX:a._width/
2||0,g=typeof a._originY==="number"?a._originY:a._height/2||0,k=[e,g];d.multiplyVec(f,k,k);a._offsetX=k[0]-e;a._offsetY=k[1]-g;a._dirty=!1},_determineEventTarget:function(a){return this._getEntityByPosition(a.x,a.y)},_getEntityByPosition:function(a,b){var d=c.Core.instance,e=this._dctx;if(this._lastDetected<d.frame)e.clearRect(0,0,this.width,this.height),this._detectrendering(this),this._lastDetected=d.frame;return this._colorManager.getSpriteByColor(e.getImageData(a,b,1,1).data)}});c.CanvasLayer._attachCache=
function(a,b,d,e){var f;if(!a._cvsCache)a._cvsCache={},a._cvsCache.matrix=[1,0,0,1,0,0],a._cvsCache.detectColor="rgba("+b._colorManager.attachDetectColor(a)+")",a.addEventListener("childadded",d),a.addEventListener("childremoved",e);if(a.childNodes)for(var g=0,k=a.childNodes.length;g<k;g++)f=a.childNodes[g],c.CanvasLayer._attachCache(f,b,d,e)};c.CanvasLayer._detachCache=function(a,b,d,e){var f;a._cvsCache&&(b._colorManager.detachDetectColor(a),a.removeEventListener("childadded",d),a.removeEventListener("childremoved",
e),delete a._cvsCache);if(a.childNodes)for(var g=0,k=a.childNodes.length;g<k;g++)f=a.childNodes[g],c.CanvasLayer._detachCache(f,b,d,e)};c.Screen=c.Class.extend(c.Group,{_context:null,initialize:function(){var a=c.Core.instance;c.Group.call(this);this.width=a.width;this.height=a.height;this.screen=this;this._backgroundColor=null;this._element=document.createElement("div");this._element.style.width=this.width+"px";this._element.style.height=this.height+"px";this._element.style.position="absolute";this._element.style.overflow=
"hidden";this._element.style[c.System.BROWSER+"TransformOrigin"]="0 0";this._element.style[c.System.BROWSER+"Transform"]="scale("+c.Core.instance.scale+")";this._layers={};this._layerPriority=[];this.addEventListener(c.Event.CHILD_ADDED,this._onchildadded);this.addEventListener(c.Event.CHILD_REMOVED,this._onchildremoved);this.addEventListener(c.Event.ENTER,this._onenter);this.addEventListener(c.Event.EXIT,this._onexit);var b=this;this._dispatchExitframe=function(){var a,e;for(e in b._layers)a=b._layers[e],
a.dispatchEvent(new c.Event(c.Event.EXIT_FRAME))}},x:{get:function(){return this._x},set:function(a){this._x=a;for(var b in this._layers)this._layers[b].x=a}},y:{get:function(){return this._y},set:function(a){this._y=a;for(var b in this._layers)this._layers[b].y=a}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation=a;for(var b in this._layers)this._layers[b].rotation=a}},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX=a;for(var b in this._layers)this._layers[b].scaleX=
a}},scaleY:{get:function(){return this._scaleY},set:function(a){this._scaleY=a;for(var b in this._layers)this._layers[b].scaleY=a}},backgroundColor:{get:function(){return this._backgroundColor},set:function(a){this._backgroundColor=this._element.style.backgroundColor=a}},addLayer:function(a,b){var d=c.Core.instance;if(!this._layers[a]){var e=new c[a+"Layer"];d.currentScreen===this&&e._startRendering();this._layers[a]=e;d=e._element;typeof b==="number"?(this._element.insertBefore(d,this._element.childNodes[b]),
this._layerPriority.splice(b,0,a)):(this._element.appendChild(d),this._layerPriority.push(a));e._screen=this;this._context=e.getContext()}},_determineEventTarget:function(a){for(var b,d=this._layerPriority.length-1;d>=0;d--)if(b=this._layers[this._layerPriority[d]],b=b._determineEventTarget(a))break;b||(b=this);return b},_onchildadded:function(a){var b=a.node,a=a.next;b._element?(this._layers.Dom||this.addLayer("Dom",1),this._layers.Dom.insertBefore(b,a),b._layer=this._layers.Dom):(this._layers.Canvas||
this.addLayer("Canvas",0),this._layers.Canvas.insertBefore(b,a),b._layer=this._layers.Canvas);b.parentNode=this},_onchildremoved:function(a){a=a.node;a._layer.removeChild(a);a._layer=null},_onenter:function(){for(var a in this._layers)this._layers[a]._startRendering();c.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){for(var a in this._layers)this._layers[a]._stopRendering();c.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}});c.Bitmap=
c.Class.extend(c.EventTarget,{initialize:function(a,b){c.EventTarget.call(this);var d=c.Core.instance;this.width=a;this.height=b;this.context=null;d="lgraphics"+d._surfaceID++;document.getCSSCanvasContext?(this.context=document.getCSSCanvasContext("2d",d,a,b),this._element=this.context.canvas,this._css="-webkit-canvas("+d+")"):document.mozSetImageElement?(this._element=document.createElement("canvas"),this._element.width=a,this._element.height=b,this._css="-moz-element(#"+d+")",this.context=this._element.getContext("2d"),
document.mozSetImageElement(d,this._element)):(this._element=document.createElement("canvas"),this._element.width=a,this._element.height=b,this._element.style.position="absolute",this.context=this._element.getContext("2d"),c.System.CANVAS_DRAWING_METHODS.forEach(function(a){var b=this.context[a];this.context[a]=function(){b.apply(this,arguments);this._dirty=!0}},this))},getImage:function(){return this.context},getWidth:function(){return this.width},getHeight:function(){return this.height},getPixel:function(a,
b){return this.context.getImageData(a,b,1,1).data},setPixel:function(a,b,d,c,f,g){var k=this.context.createImageData(1,1);k.data[0]=d;k.data[1]=c;k.data[2]=f;k.data[3]=g;this.context.putImageData(k,a,b)},clear:function(){this.context.clearRect(0,0,this.width,this.height)},draw:function(a){a=a._element;if(arguments.length===1)this.context.drawImage(a,0,0);else{var b=arguments;b[0]=a;this.context.drawImage.apply(this.context,b)}},clone:function(){var a=new c.Bitmap(this.width,this.height);a.draw(this);
return a},toDataURL:function(){var a=this._element.src;return a?a.slice(0,5)==="data:"?a:this.clone().toDataURL():this._element.toDataURL()}});c.Bitmap.load=function(a){var b=new Image,d=Object.extend(c.Bitmap.prototype,{context:{value:null},_css:{value:"url("+a+")"},_element:{value:b}});c.EventTarget.call(d);b.src=a;b.onerror=function(){throw Error("Cannot load an asset: "+b.src);};b.onload=function(){d.width=b.width;d.height=b.height;d.dispatchEvent(new c.Event("load"))};return d};c.Pad=c.Class.extend(c.Sprite,
{initialize:function(a){a=c.Core.instance.file[a];c.Sprite.call(this,a.width,a.height);this.image=a;this.input={left:!1,right:!1,up:!1,down:!1};this.addEventListener("touchstart",function(a){this._updateInput(this._detectInput(a.localX,a.localY))});this.addEventListener("touchmove",function(a){this._updateInput(this._detectInput(a.localX,a.localY))});this.addEventListener("touchend",function(){this._updateInput({left:!1,right:!1,up:!1,down:!1})})},_detectInput:function(a,b){a-=this.width/2;b-=this.height/
2;var d={left:!1,right:!1,up:!1,down:!1};if(a*a+b*b>200){if(a<0&&b<a*a*0.1&&b>a*a*-0.1)d.left=!0;if(a>0&&b<a*a*0.1&&b>a*a*-0.1)d.right=!0;if(b<0&&a<b*b*0.1&&a>b*b*-0.1)d.up=!0;if(b>0&&a<b*b*0.1&&a>b*b*-0.1)d.down=!0}return d},_updateInput:function(a){var b=c.Core.instance;["left","right","up","down"].forEach(function(d){this.input[d]&&!a[d]&&b.dispatchEvent(new c.Event(d+"buttonup"));!this.input[d]&&a[d]&&b.dispatchEvent(new c.Event(d+"buttondown"))},this);this.input=a}});c.Control=c.Class.extend(c.Group,
{initialize:function(a,b){var d=c.Core.instance.file[a],e=this.width=d.width,f=this.height=d.height;c.Group.call(this);this.outside=new c.Sprite(e,f);var g=new c.Bitmap(e,f);g.draw(d,0,0,e,f/4,0,0,e,f/4);g.draw(d,0,f/4*3,e,f/4,0,f/4*3,e,f/4);g.draw(d,0,f/4,e/4,f/2,0,f/4,e/4,f/2);g.draw(d,e/4*3,f/4,e/4,f/2,e/4*3,f/4,e/4,f/2);this.outside.image=g;this.inside=new c.Sprite(e/2,f/2);g=new c.Bitmap(e/2,f/2);g.draw(d,e/4,f/4,e/2,f/2,0,0,e/2,f/2);this.inside.image=g;this.r=e/2;this.isTouched=!1;this.dist=
this.rad=this.vy=this.vx=0;this.mode=b==="direct"?"direct":"normal";this._updateImage();this.addChild(this.inside);this.addChild(this.outside);this.addEventListener("touchstart",function(a){this._detectInput(a.localX,a.localY);this._calcPolar(a.localX,a.localY);this._updateImage(a.localX,a.localY);this._dispatchPadEvent("apadstart");this.isTouched=!0});this.addEventListener("touchmove",function(a){this._detectInput(a.localX,a.localY);this._calcPolar(a.localX,a.localY);this._updateImage(a.localX,a.localY);
this._dispatchPadEvent("apadmove")});this.addEventListener("touchend",function(){this._detectInput(this.width/2,this.height/2);this._calcPolar(this.width/2,this.height/2);this._updateImage(this.width/2,this.height/2);this._dispatchPadEvent("apadend");this.isTouched=!1})},_dispatchPadEvent:function(a){a=new c.Event(a);a.vx=this.vx;a.vy=this.vy;a.rad=this.rad;a.dist=this.dist;this.dispatchEvent(a)},_updateImage:function(){this.inside.x=this.vx*(this.r-10)+25;this.inside.y=this.vy*(this.r-10)+25},_detectInput:function(a,
b){a-=this.width/2;b-=this.height/2;var d=Math.sqrt(a*a+b*b),c=Math.atan(b/a),f=a/Math.abs(a);d===0?this.vy=this.vx=0:a===0?(this.vx=0,this.mode==="direct"?this.vy=b/this.r:(f=b/Math.abs(b),this.vy=Math.pow(b/this.r,2)*f)):d<this.r?this.mode==="direct"?(this.vx=a/this.r,this.vy=b/this.r):(this.vx=Math.pow(d/this.r,2)*Math.cos(c)*f,this.vy=Math.pow(d/this.r,2)*Math.sin(c)*f):(this.vx=Math.cos(c)*f,this.vy=Math.sin(c)*f)},_calcPolar:function(a,b){a-=this.width/2;b-=this.height/2;var d=0,c=0,f=Math.sqrt(a*
a+b*b);if(f>this.r)f=this.r;f/=this.r;this.mode==="normal"&&(f*=f);a>=0&&b<0?(d=Math.PI/2*3,c=a/b):a<0&&b<=0?(d=Math.PI,c=b/a):a<=0&&b>0?(d=Math.PI/2,c=a/b):a>0&&b>=0&&(d=0,c=b/a);if(a===0||b===0)c=0;this.rad=Math.abs(Math.atan(c))+d;this.dist=f}});c.DOMSound=c.Class.extend(c.EventTarget,{initialize:function(){c.EventTarget.call(this);this.duration=0;throw Error("Illegal Constructor");},play:function(){this._element&&this._element.play()},pause:function(){this._element&&this._element.pause()},exit:function(){this.pause();
this.currentTime=0},clone:function(){var a;if(this._element instanceof Audio)a=Object.extend(c.DOMSound.prototype,{_element:{value:this._element.cloneNode(!1)},duration:{value:this.duration}});else if(c.System.SUPPORT_FLASH_SOUND)return this;else a=Object.extend(c.DOMSound.prototype);c.EventTarget.call(a);return a},currentTime:{get:function(){return this._element?this._element.currentTime:0},set:function(a){if(this._element)this._element.currentTime=a}},volume:{get:function(){return this._element?
this._element.volume:1},set:function(a){if(this._element)this._element.volume=a}}});c.DOMSound.load=function(a,b,d){b==null&&(b=(b=c.Core.findExt(a))?"audio/"+b:"");var b=b.replace("mp3","mpeg").replace("m4a","mp4"),e=Object.extend(c.DOMSound.prototype);c.EventTarget.call(e);var f=new Audio;if(!c.System.SOUND_ENABLED_ON_MOBILE_SAFARI&&c.System.BROWSER==="webkit"&&c.System.SUPPORT_TOUCH)h.setTimeout(function(){e.dispatchEvent(new c.Event("load"))},0);else{if(!c.System.SUPPORT_FLASH_SOUND&&f.canPlayType(b))f.src=
a,f.load(),f.autoplay=!1,f.onerror=function(){throw Error("Cannot load an asset: "+f.src);},f.addEventListener("canplaythrough",function(){e.duration=f.duration;e.dispatchEvent(new c.Event("load"))},!1),e._element=f;else if(b==="audio/mpeg"){var g=document.createElement("embed"),b="loon-audio"+c.Core.instance._soundID++;g.width=g.height=1;g.name=b;g.src="sound.swf?id="+b+"&src="+a;g.allowscriptaccess="always";g.style.position="absolute";g.style.left="-1px";e.addEventListener("load",function(){Object.defineProperties(g,
{currentTime:{get:function(){return g.getCurrentTime()},set:function(a){g.setCurrentTime(a)}},volume:{get:function(){return g.getVolume()},set:function(a){g.setVolume(a)}}});e._element=g;e.duration=g.getDuration()});c.Core.instance._element.appendChild(g);c.DOMSound[b]=e}else h.setTimeout(function(){e.dispatchEvent(new c.Event("load"))},0);e.addEventListener("load",function(){d.call(c.Core.instance)})}return e};h.AudioContext=h.AudioContext||h.webkitAudioContext||h.mozAudioContext||h.msAudioContext||
h.oAudioContext;c.WebAudioSound=c.Class.extend(c.EventTarget,{initialize:function(){if(!h.webkitAudioContext)throw Error("This browser does not support WebAudio API.");var a=c.WebAudioSound.audioContext;c.EventTarget.call(this);this.src=a.createBufferSource();this.buffer=null;this._volume=1;this._state=this._currentTime=0;this.connectTarget=c.WebAudioSound.destination},play:function(a){var b=c.WebAudioSound.audioContext;this._state===2?this.src.connect(this.connectTarget):(this._state===1&&!a&&this.src.disconnect(this.connectTarget),
this.src=b.createBufferSource(),this.src.buffer=this.buffer,this.src.gain.value=this._volume,this.src.connect(this.connectTarget),this.src.noteOn(0));this._state=1},pause:function(){this.src.disconnect(this.connectTarget);this._state=2},exit:function(){this.src.noteOff(0);this._state=0},clone:function(){var a=new c.WebAudioSound;a.buffer=this.buffer;return a},dulation:{get:function(){return this.buffer?this.buffer.dulation:0}},volume:{get:function(){return this._volume},set:function(a){this._volume=
a=Math.max(0,Math.min(1,a));if(this.src)this.src.gain.value=a}},currentTime:{get:function(){return this._currentTime},set:function(a){this._currentTime=a}}});c.WebAudioSound.load=function(a,b,d){var e=c.WebAudioSound.audioContext,f=h.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Msxml2.XMLHTTP"),g=new c.WebAudioSound;c.Core.findExt(a);f.responseType="arraybuffer";f.open("GET",a,!0);f.onload=function(){e.decodeAudioData(f.response,function(a){g.buffer=a;d.call(c.Core.instance)},function(a){h.console.log(a)})};
f.send(null);return g};if(h.AudioContext)c.WebAudioSound.audioContext=new h.AudioContext,c.WebAudioSound.destination=c.WebAudioSound.audioContext.destination;c.Sound=h.AudioContext&&c.System.USE_WEBAUDIO?c.WebAudioSound:c.DOMSound;c.Easing={LINEAR:function(a,b,d,c){return d*a/c+b},SWING:function(a,b,d,c){return d*(0.5-Math.cos(a/c*Math.PI)/2)+b},QUAD_EASEIN:function(a,b,d,c){return d*(a/=c)*a+b},QUAD_EASEOUT:function(a,b,d,c){return-d*(a/=c)*(a-2)+b},QUAD_EASEINOUT:function(a,b,d,c){return(a/=c/2)<
1?d/2*a*a+b:-d/2*(--a*(a-2)-1)+b},CUBIC_EASEIN:function(a,b,d,c){return d*(a/=c)*a*a+b},CUBIC_EASEOUT:function(a,b,d,c){return d*((a=a/c-1)*a*a+1)+b},CUBIC_EASEINOUT:function(a,b,c,e){return(a/=e/2)<1?c/2*a*a*a+b:c/2*((a-=2)*a*a+2)+b},QUART_EASEIN:function(a,b,c,e){return c*(a/=e)*a*a*a+b},QUART_EASEOUT:function(a,b,c,e){return-c*((a=a/e-1)*a*a*a-1)+b},QUART_EASEINOUT:function(a,b,c,e){return(a/=e/2)<1?c/2*a*a*a*a+b:-c/2*((a-=2)*a*a*a-2)+b},QUINT_EASEIN:function(a,b,c,e){return c*(a/=e)*a*a*a*a+b},
QUINT_EASEOUT:function(a,b,c,e){return c*((a=a/e-1)*a*a*a*a+1)+b},QUINT_EASEINOUT:function(a,b,c,e){return(a/=e/2)<1?c/2*a*a*a*a*a+b:c/2*((a-=2)*a*a*a*a+2)+b},SIN_EASEIN:function(a,b,c,e){return-c*Math.cos(a/e*(Math.PI/2))+c+b},SIN_EASEOUT:function(a,b,c,e){return c*Math.sin(a/e*(Math.PI/2))+b},SIN_EASEINOUT:function(a,b,c,e){return-c/2*(Math.cos(Math.PI*a/e)-1)+b},CIRC_EASEIN:function(a,b,c,e){return-c*(Math.sqrt(1-(a/=e)*a)-1)+b},CIRC_EASEOUT:function(a,b,c,e){return c*Math.sqrt(1-(a=a/e-1)*a)+
b},CIRC_EASEINOUT:function(a,b,c,e){return(a/=e/2)<1?-c/2*(Math.sqrt(1-a*a)-1)+b:c/2*(Math.sqrt(1-(a-=2)*a)+1)+b},ELASTIC_EASEIN:function(a,b,c,e,f,g){if(a===0)return b;if((a/=e)===1)return b+c;g||(g=e*0.3);!f||f<Math.abs(c)?(f=c,c=g/4):c=g/(2*Math.PI)*Math.asin(c/f);return-(f*Math.pow(2,10*(a-=1))*Math.sin((a*e-c)*2*Math.PI/g))+b},ELASTIC_EASEOUT:function(a,b,c,e,f,g){if(a===0)return b;if((a/=e)===1)return b+c;g||(g=e*0.3);var h;!f||f<Math.abs(c)?(f=c,h=g/4):h=g/(2*Math.PI)*Math.asin(c/f);return f*
Math.pow(2,-10*a)*Math.sin((a*e-h)*2*Math.PI/g)+c+b},ELASTIC_EASEINOUT:function(a,b,c,e,f,g){if(a===0)return b;if((a/=e/2)===2)return b+c;g||(g=e*0.3*1.5);var h;!f||f<Math.abs(c)?(f=c,h=g/4):h=g/(2*Math.PI)*Math.asin(c/f);return a<1?-0.5*f*Math.pow(2,10*(a-=1))*Math.sin((a*e-h)*2*Math.PI/g)+b:f*Math.pow(2,-10*(a-=1))*Math.sin((a*e-h)*2*Math.PI/g)*0.5+c+b},BOUNCE_EASEOUT:function(a,b,c,e){return(a/=e)<1/2.75?c*7.5625*a*a+b:a<2/2.75?c*(7.5625*(a-=1.5/2.75)*a+0.75)+b:a<2.5/2.75?c*(7.5625*(a-=2.25/2.75)*
a+0.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+0.984375)+b},BOUNCE_EASEIN:function(a,b,d,e){return d-c.Easing.BOUNCE_EASEOUT(e-a,0,d,e)+b},BOUNCE_EASEINOUT:function(a,b,d,e){return a<e/2?c.Easing.BOUNCE_EASEIN(a*2,0,d,e)*0.5+b:c.Easing.BOUNCE_EASEOUT(a*2-e,0,d,e)*0.5+d*0.5+b},BACK_EASEIN:function(a,b,c,e,f){f===n&&(f=1.70158);return c*(a/=e)*a*((f+1)*a-f)+b},BACK_EASEOUT:function(a,b,c,e,f){f===n&&(f=1.70158);return c*((a=a/e-1)*a*((f+1)*a+f)+1)+b},BACK_EASEINOUT:function(a,b,c,e,f){f===n&&(f=1.70158);return(a/=
e/2)<1?c/2*a*a*(((f*=1.525)+1)*a-f)+b:c/2*((a-=2)*a*(((f*=1.525)+1)*a+f)+2)+b},EXPO_EASEIN:function(a,b,c,e){return a===0?b:c*Math.pow(2,10*(a/e-1))+b},EXPO_EASEOUT:function(a,b,c,e){return a===e?b+c:c*(-Math.pow(2,-10*a/e)+1)+b},EXPO_EASEINOUT:function(a,b,c,e){return a===0?b:a===e?b+c:(a/=e/2)<1?c/2*Math.pow(2,10*(a-1))+b:c/2*(-Math.pow(2,-10*--a)+2)+b}};c.ActionEventTarget=c.Class.extend(c.EventTarget,{initialize:function(){c.EventTarget.apply(this,arguments)},dispatchEvent:function(a){var b;this.node?
(b=this.node,a.target=b,a.localX=a.x-b._offsetX,a.localY=a.y-b._offsetY):this.node=null;this["on"+a.type]!=null&&this["on"+a.type].call(b,a);var c=this._listeners[a.type];if(c!=null)for(var c=c.slice(),e=0,f=c.length;e<f;e++)c[e].call(b,a)}});c.Timeline=c.Class.extend(c.EventTarget,{initialize:function(a){c.EventTarget.call(this);this.node=a;this.queue=[];this.looped=this.paused=!1;this.isFrameBased=!0;this._parallel=null;this._activated=!1;this.addEventListener(c.Event.ENTER_FRAME,this.tick)},_deactivateTimeline:function(){if(this._activated)this._activated=
!1,this.node.removeEventListener("enterframe",this._nodeEventListener)},_activateTimeline:function(){if(!this._activated&&!this.paused)this.node.addEventListener("enterframe",this._nodeEventListener),this._activated=!0},setFrameBased:function(){this.isFrameBased=!0},setTimeBased:function(){this.isFrameBased=!1},next:function(a){var b,d=this.queue.shift();b=new c.Event("actionend");b.timeline=this;d.dispatchEvent(b);if(this.queue.length===0)this._activated=!1,this.node.removeEventListener("enterframe",
this._nodeEventListener);else if(this.looped?(b=new c.Event("removedfromtimeline"),b.timeline=this,d.dispatchEvent(b),d.frame=0,this.add(d)):(b=new c.Event("removedfromtimeline"),b.timeline=this,d.dispatchEvent(b)),a>0||this.queue[0]&&this.queue[0].time===0)b=new c.Event("enterframe"),b.elapsed=a,this.dispatchEvent(b)},tick:function(a){if(!this.paused&&this.queue.length>0){var b=this.queue[0];if(b.frame===0){var d;d=new c.Event("actionstart");d.timeline=this;b.dispatchEvent(d)}d=new c.Event("actiontick");
d.timeline=this;d.elapsed=this.isFrameBased?1:a.elapsed;b.dispatchEvent(d)}},add:function(a){if(!this._activated){var b=this;this._nodeEventListener=function(a){b.dispatchEvent(a)};this.node.addEventListener("enterframe",this._nodeEventListener);this._activated=!0}this._parallel?(this._parallel.actions.push(a),this._parallel=null):this.queue.push(a);a.frame=0;var d=new c.Event("addedtotimeline");d.timeline=this;a.dispatchEvent(d);d=new c.Event("actionadded");d.action=a;this.dispatchEvent(d);return this},
action:function(a){return this.add(new c.Action(a))},tween:function(a){return this.add(new c.Tween(a))},clear:function(){var a=new c.Event("removedfromtimeline");a.timeline=this;for(var b=0,d=this.queue.length;b<d;b++)this.queue[b].dispatchEvent(a);this.queue=[];this._deactivateTimeline();return this},skip:function(a){var b=new c.Event("enterframe");this.isFrameBased?b.elapsed=1:(b.elapsed=a,a=1);for(;a--;)this.dispatchEvent(b);return this},pause:function(){if(!this.paused)this.paused=!0,this._deactivateTimeline();
return this},resume:function(){if(this.paused)this.paused=!1,this._activateTimeline();return this},loop:function(){this.looped=!0;return this},unloop:function(){this.looped=!1;return this},delay:function(a){this.add(new c.Action({time:a}));return this},wait:function(){return this},then:function(a){var b=this;this.add(new c.Action({onactiontick:function(){a.call(b.node)},time:0}));return this},exec:function(a){this.then(a)},cue:function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&(this.delay(c-b),
this.then(a[c]),b=c)},repeat:function(a,b){this.add(new c.Action({onactiontick:function(){a.call(this)},time:b}));return this},and:function(){var a=this.queue.pop();if(a instanceof c.ParallelAction)this._parallel=a,this.queue.push(a);else{var b=new c.ParallelAction;b.actions.push(a);this.queue.push(b);this._parallel=b}return this},or:function(){return this},doAll:function(){return this},waitAll:function(){return this},waitUntil:function(a){var b=this;this.add(new c.Action({onactionstart:a,onactiontick:function(){a.call(this)&&
b.next()}}));return this},fadeTo:function(a,b,c){this.tween({opacity:a,time:b,easing:c});return this},fadeIn:function(a,b){return this.fadeTo(1,a,b)},fadeOut:function(a,b){return this.fadeTo(0,a,b)},moveTo:function(a,b,c,e){return this.tween({x:a,y:b,time:c,easing:e})},moveX:function(a,b,c){return this.tween({x:a,time:b,easing:c})},moveY:function(a,b,c){return this.tween({y:a,time:b,easing:c})},moveBy:function(a,b,c,e){return this.tween({x:function(){return this.x+a},y:function(){return this.y+b},
time:c,easing:e})},hide:function(){return this.then(function(){this.opacity=0})},show:function(){return this.then(function(){this.opacity=1})},removeFromScreen:function(){return this.then(function(){this.screen.removeChild(this)})},scaleTo:function(a,b,c,e){return typeof c==="number"?this.tween({scaleX:a,scaleY:b,time:c,easing:e}):this.tween({scaleX:a,scaleY:a,time:b,easing:c})},scaleBy:function(a,b,c,e){return typeof c==="number"?this.tween({scaleX:function(a){return this.scaleX*a},scaleY:function(a,
b){return this.scaleY*b},time:c,easing:e}):this.tween({scaleX:function(){return this.scaleX*a},scaleY:function(){return this.scaleY*a},time:b,easing:c})},rotateTo:function(a,b,c){return this.tween({rotation:a,time:b,easing:c})},rotateBy:function(a,b,c){return this.tween({rotation:function(){return this.rotation+a},time:b,easing:c})}});c.Action=c.Class.extend(c.ActionEventTarget,{initialize:function(a){c.ActionEventTarget.call(this);this.time=null;this.frame=0;for(var b in a)a.hasOwnProperty(b)&&a[b]!=
null&&(this[b]=a[b]);var d=this;this.node=this.timeline=null;this.addEventListener(c.Event.ADDED_TO_TIMELINE,function(a){d.timeline=a.timeline;d.node=a.timeline.node;d.frame=0});this.addEventListener(c.Event.REMOVED_FROM_TIMELINE,function(){d.timeline=null;d.node=null;d.frame=0});this.addEventListener(c.Event.ACTION_TICK,function(a){var b=d.time-(d.frame+a.elapsed);d.time!=null&&b<=0?(d.frame=d.time,a.timeline.next(-b)):d.frame+=a.elapsed})}});config.beforeLoadMainFunction&&G()})(window);
